---
title: "amort-prepay-v03"
output: html_document
date: "2025-04-26"
---

```{r setup, include=FALSE}
library(dplyr)
library(data.table)
knitr::opts_chunk$set(echo = FALSE)
```

```{r parameters}
orig.term<-360
note.rate<-0.06
orig.bal<-100000
scalar.cpr<-0.04 # curtailment
cpr<-replicate(orig.term,scalar.cpr)
# string equivalents
scalar.smm<-1-(1-scalar.cpr)^(1/12)
note.rate.str<-sprintf("%5.2f%%",note.rate*100)
orig.bal.str<-prettyNum(orig.bal,big.mark=",", scientific=FALSE)

scalar.cpr.str<-sprintf("%5.2f%%",scalar.cpr*100)
scalar.smm.str<-sprintf("%5.2f%%",scalar.smm*100)
```
```{r pool.simulation.params}
loan.count<-50
```

```{r level.pay.calc_f}
level.pay.calc<-function(rem.term,monthly.rate)
{
  monthly.payment<-(monthly.rate*(1+monthly.rate)^rem.term)/((1+monthly.rate)^rem.term-1)
  return(monthly.payment)
}
```

```{r amort.loan.cf_f}
# amortize single loan incorporating prepayments
# CPR == 1 signifies paid-in-full
# 0 < CPR < 1 are curtailments
amort.loan.cf<-function(orig.term,note.rate,orig.bal,cpr=c(NA))
{
  monthly.rate<-note.rate/12
  if(is.na(cpr[1])){
    smm<-replicate(orig.term,0)
  } else {
    smm<-1-(1-cpr)^(1/12)
  }
  level.pay<-level.pay.calc(orig.term,monthly.rate)*orig.bal
  cf<-data.table(mon=1:orig.term)
  cf[1,bbal:=orig.bal]
  cf[,int:=0]
  cf[,sched.prin:=0]
  cf[,unsched.prin:=0]
  cf[,prin:=0]
  cf[,eschedbal:=0]
  cf[,ebal:=0]
  mo.bbal<-orig.bal
  mo.unsched.prin<-0
  for(m in 1:orig.term){
    mo.int<-mo.bbal * monthly.rate
    mo.sched.prin<-level.pay - mo.int
    mo.eschedbal<-mo.bbal - mo.sched.prin
    mo.unsched.prin<-mo.eschedbal*smm[m]
    mo.prin<-mo.sched.prin + mo.unsched.prin
    mo.ebal<-mo.bbal - mo.prin
    cf[m,bbal:=round(mo.bbal,2)]
    cf[m,int:=round(mo.int,2)]
    cf[m,sched.prin:=round(mo.sched.prin,2)]
    cf[m,unsched.prin:=round(mo.unsched.prin,2)]
    cf[m,prin:=round(mo.prin,2)]
    cf[m,eschedbal:=round(mo.eschedbal,2)]
    cf[m,ebal:=round(mo.ebal,2)]
    if(mo.ebal<=0.005) break
    mo.bbal<-mo.ebal # for next month
  }
  return (cf)
} # amort.loan.cf
``` 


```{r amort.pool.cf_f}
# Prepayments are continuous
# Pool consisting of many loans of 0.01 each
# CPR represents % of loans that pay in full that month
# 

amort.pool.cf<-function(orig.term,note.rate,orig.bal,cpr=c(NA))
{
  monthly.rate<-note.rate/12
  if(is.na(cpr[1])){
    smm<-replicate(orig.term,0)
  } else {
    smm<-1-(1-cpr)^(1/12)
  }
  cf<-data.table(mon=1:orig.term)
  cf[1,bbal:=orig.bal]
  cf[,int:=0]
  cf[,sched.prin:=0]
  cf[,unsched.prin:=0]
  cf[,prin:=0]
  cf[,eschedbal:=0]
  cf[,ebal:=0]
  mo.bbal<-orig.bal
  mo.unsched.prin<-0
  for(m in 1:orig.term){
    level.pay<-level.pay.calc(orig.term+1-m,monthly.rate)*mo.bbal
    mo.int<-mo.bbal * monthly.rate
    mo.sched.prin<-level.pay - mo.int
    mo.eschedbal<-mo.bbal - mo.sched.prin
    mo.unsched.prin<-mo.eschedbal*smm[m]
    mo.prin<-mo.sched.prin + mo.unsched.prin
    
    mo.ebal<-mo.bbal - mo.prin
    cf[m,bbal:=round(mo.bbal,2)]
    cf[m,int:=round(mo.int,2)]
    cf[m,sched.prin:=round(mo.sched.prin,2)]
    cf[m,unsched.prin:=round(mo.unsched.prin,2)]
    cf[m,prin:=round(mo.prin,2)]
    cf[m,eschedbal:=round(mo.eschedbal,2)]
    cf[m,ebal:=round(mo.ebal,2)]
    if(mo.ebal<=0.005) break
    mo.bbal<-mo.ebal # for next month
  }
  return (cf)
} # amort.pool.cf
``` 


## Amortization and Prepayment Calculations

### Parameters

* Original Term = `r orig.term`

* Note rate = `r note.rate.str`

* Original Loan Balance = `r orig.bal.str`

* Conditional Prepayment Rate (CPR) = `r scalar.cpr.str`

* Pool Loan Count = `r loan.count`

### Amortize Single Loan

CPRs for single loans are treated as: 

1. curtailments (0% < CPR < 100%) or 

2. payments in full (CPR == 100%)

3. scheduled amortization (CPR == 0%)

Other characteristics of single loan amortization:

1. the scheduled payment does not change

2. coupon does not change over time

3. age and remaining term increment by 1 and -1 respectively every month

4. Nonzero CPR < 100% represents curtailments, which 

    a. reduces the payment window by accelerating the final paydown to zero
    
    b. do not affect scheduled (level) payment

```{r amort.loan}

#cpr[120]<-1 # paid in full
cf1<-amort.loan.cf(orig.term,note.rate,orig.bal,cpr)

par(mar = c(6, 6, 1, 1) + 0.1) # more y axis space for rotated values param 2
par(mgp = c(5, 1, 0)) # more space for y axis titles, param 1
plot(cf1$mon,cf1$ebal,xaxt="n",yaxt="n")
axis(1, at = seq(0, orig.term, 12*5))
axis(2, at = seq(0, orig.bal, orig.bal/4),
     prettyNum(seq(0, orig.bal, orig.bal/4),big.mark=",", scientific=FALSE),las=1)
```


### Amortize Pool (MBS Convention)

This is the MBS convention for modeling loan pools.
The convention assumes prepayments are *continuous*, 
implying pools consist of infinite number of loans each of *infinitesimal size*. 
There is no explicit modeling of loans and loan counts, though the latter may be inferred if average loan size is an attribute of the pool.

Balances and other quantities represent the aggregated values 
of pseudo-loans comprising the pool. 

CPRs under MBS pool convention is treated as: 

1. paid in full for a proportion of loans up to 100% (CPR > 0%) 

2. scheduled amortization (CPR == 0%)

3. There is no provision for curtailment.

#### Example: 

1. Assume flat `r scalar.cpr.str` CPR

2. `r scalar.cpr.str` CPR is annualized equivalent of `r scalar.smm.str` Single Monthly Mortality (SMM).

3. Each month, `r scalar.smm.str` of the loans are assumuled to pay in full, reducing actual balances by that amount

4. The scheduled level payment is also reduced by `r scalar.smm.str` reflecting the paydowns.

#### Other characteristics of the pool:

1. the scheduled payment changes

2. coupon does not change over time

3. age and remaining term increment by 1 and -1 respectively every month

    a. age represents Weighted Average Loan Age (WALA)
    
    b. remaining term represents Weighted Average Maturity (WAM)
  
4. Prepayments do not affect the payment window
  
  

```{r amort.pool}
pool.orig.bal<-orig.bal*loan.count
cf2<-amort.pool.cf(orig.term,note.rate,pool.orig.bal,cpr)

par(mar = c(6, 6, 1, 1) + 0.1) # more y axis space for rotated values param 2
par(mgp = c(5, 1, 0)) # more space for y axis titles, param 1
plot(cf2$mon,cf2$ebal,xaxt="n",yaxt="n")
axis(1, at = seq(0, orig.term, 12*5))
axis(2, at = seq(0, pool.orig.bal, pool.orig.bal/4),
     prettyNum(seq(0, pool.orig.bal, pool.orig.bal/4),big.mark=",", scientific=FALSE),las=1)

```

### Pool Paydowns through Loan Simulation

The simulation models a pool as an aggregate of a *specific number* of 
loans of *specific size*, which may have heterogeneous properties (different coupons, sizes, etc).

CPRs are interpreted as the probability for an individual loan being paid in full each month. There is no provision for curtailment.

#### Example: 

1. Assume flat `r scalar.cpr.str` CPR

2. `r scalar.cpr.str` CPR is annualized equivalent of `r scalar.smm.str` Single Monthly Mortality (SMM).

3. Each month, each loan has a `r scalar.smm.str` probability of paying in full.

4. The scheduled level payment is reduced by the scheduled level payments of those loans paying in full.

```{r pool.simulation}
set.seed(666)

cpr<-replicate(orig.term,scalar.cpr)
smm<-1-(1-cpr)^(1/12)

for(loan.no in 1:loan.count){
  pifcpr<-runif(n=orig.term) # random
  pifcpr<-(pifcpr<smm)*1
  #cpr[120]<-1 # paid in full
  cf1<-amort.loan.cf(orig.term,note.rate,orig.bal,pifcpr)
  if(loan.no==1){
    accum_cf<-cf1
  } else {
    accum_cf<-accum_cf+cf1
  }
}
accum_cf$mon<-accum_cf$mon/loan.count
```

```{r pool.simulation.results}

par(mar = c(6, 6, 1, 1) + 0.1) # more y axis space for rotated values param 2
par(mgp = c(5, 1, 0)) # more space for y axis titles, param 1
plot(accum_cf$mon,accum_cf$ebal,xaxt="n",yaxt="n")
axis(1, at = seq(0, orig.term, 12*5))
axis(2, at = seq(0, pool.orig.bal, pool.orig.bal/4),
     prettyNum(seq(0, pool.orig.bal, pool.orig.bal/4),big.mark=",", scientific=FALSE),las=1)
lines(cf2$mon,cf2$ebal,type="l",col="red",lwd=2,lty=2)
```

### Amortization Functions

#### Single Loan Amortization 

```{r level.pay.calc_f,eval=FALSE,echo=TRUE}
```

```{r amort.loan.cf_f,eval=FALSE,echo=TRUE}
```

#### MBS Convention Pool Amortization 

```{r amort.pool.cf_f,eval=FALSE,echo=TRUE}
```

### Parameters

```{r parameters,eval=FALSE,echo=TRUE}
```

```{r pool.simulation.params,eval=FALSE,echo=TRUE}
```

### Run Cashflows

```{r amort.loan,eval=FALSE,echo=TRUE}
```

```{r amort.pool,eval=FALSE,echo=TRUE}
```

#### Loan Simulation Pool Amortization 


```{r pool.simulation,eval=FALSE,echo=TRUE}
```

```{r pool.simulation.results,eval=FALSE,echo=TRUE}
```
